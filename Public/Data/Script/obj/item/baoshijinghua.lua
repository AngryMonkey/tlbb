--道具：宝石精华
--脚本号 332206
--Author:  houzhifang  2008-11-06

x332206_g_scriptId = 332206


x332206_g_ItemData = 
{
	--虎眼石精华
{ItemIndex = 30501174, GiveItem = 30504028, ImpactId = 31615},
{ItemIndex = 30501175, GiveItem = 30504029, ImpactId = 31616},
{ItemIndex = 30501176, GiveItem = 30504030, ImpactId = 31617},
{ItemIndex = 30501177, GiveItem = 30504031, ImpactId = 31618},
{ItemIndex = 30501178, GiveItem = 30504032, ImpactId = 31619},
{ItemIndex = 30501179, GiveItem = 30504033, ImpactId = 31620},
{ItemIndex = 30501180, GiveItem = 30504034, ImpactId = 31621},
{ItemIndex = 30501181, GiveItem = 30504035, ImpactId = 31622},
{ItemIndex = 30501182, GiveItem = 30504036, ImpactId = 31623},
{ItemIndex = 30504040, GiveItem = 30504031, ImpactId = 31618},
--猫眼石精华
{ItemIndex = 30501183, GiveItem = 30504028, ImpactId = 31624},
{ItemIndex = 30501184, GiveItem = 30504029, ImpactId = 31625},
{ItemIndex = 30501185, GiveItem = 30504030, ImpactId = 31626},
{ItemIndex = 30501186, GiveItem = 30504031, ImpactId = 31627},
{ItemIndex = 30501187, GiveItem = 30504032, ImpactId = 31628},
{ItemIndex = 30501188, GiveItem = 30504033, ImpactId = 31629},
{ItemIndex = 30501189, GiveItem = 30504034, ImpactId = 31630},
{ItemIndex = 30501190, GiveItem = 30504035, ImpactId = 31631},
{ItemIndex = 30501191, GiveItem = 30504036, ImpactId = 31632},
{ItemIndex = 30504041, GiveItem = 30504031, ImpactId = 31627},
--紫玉精华
{ItemIndex = 30501192, GiveItem = 30504028, ImpactId = 31633},
{ItemIndex = 30501193, GiveItem = 30504029, ImpactId = 31634},
{ItemIndex = 30501194, GiveItem = 30504030, ImpactId = 31635},
{ItemIndex = 30501195, GiveItem = 30504031, ImpactId = 31636},
{ItemIndex = 30501196, GiveItem = 30504032, ImpactId = 31637},
{ItemIndex = 30501197, GiveItem = 30504033, ImpactId = 31638},
{ItemIndex = 30501198, GiveItem = 30504034, ImpactId = 31639},
{ItemIndex = 30501199, GiveItem = 30504035, ImpactId = 31640},
{ItemIndex = 30501200, GiveItem = 30504036, ImpactId = 31641},
--祖母绿精华
{ItemIndex = 30501201, GiveItem = 30504028, ImpactId = 31642},
{ItemIndex = 30501202, GiveItem = 30504029, ImpactId = 31643},
{ItemIndex = 30501203, GiveItem = 30504030, ImpactId = 31644},
{ItemIndex = 30501204, GiveItem = 30504031, ImpactId = 31645},
{ItemIndex = 30501205, GiveItem = 30504032, ImpactId = 31646},
{ItemIndex = 30501206, GiveItem = 30504033, ImpactId = 31647},
{ItemIndex = 30501207, GiveItem = 30504034, ImpactId = 31648},
{ItemIndex = 30501208, GiveItem = 30504035, ImpactId = 31649},
{ItemIndex = 30501209, GiveItem = 30504036, ImpactId = 31650},
--红晶石精华
{ItemIndex = 30501210, GiveItem = 30504028, ImpactId = 31660},
{ItemIndex = 30501211, GiveItem = 30504029, ImpactId = 31661},
{ItemIndex = 30501212, GiveItem = 30504030, ImpactId = 31662},
{ItemIndex = 30501213, GiveItem = 30504031, ImpactId = 31663},
{ItemIndex = 30501214, GiveItem = 30504032, ImpactId = 31664},
{ItemIndex = 30501215, GiveItem = 30504033, ImpactId = 31665},
{ItemIndex = 30501216, GiveItem = 30504034, ImpactId = 31666},
{ItemIndex = 30501217, GiveItem = 30504035, ImpactId = 31667},
{ItemIndex = 30501218, GiveItem = 30504036, ImpactId = 31668},
--蓝晶石精华
{ItemIndex = 30501219, GiveItem = 30504028, ImpactId = 31651},
{ItemIndex = 30501220, GiveItem = 30504029, ImpactId = 31652},
{ItemIndex = 30501221, GiveItem = 30504030, ImpactId = 31653},
{ItemIndex = 30501222, GiveItem = 30504031, ImpactId = 31654},
{ItemIndex = 30501223, GiveItem = 30504032, ImpactId = 31655},
{ItemIndex = 30501224, GiveItem = 30504033, ImpactId = 31656},
{ItemIndex = 30501225, GiveItem = 30504034, ImpactId = 31657},
{ItemIndex = 30501226, GiveItem = 30504035, ImpactId = 31658},
{ItemIndex = 30501227, GiveItem = 30504036, ImpactId = 31659},
--黄晶石精华
{ItemIndex = 30501228, GiveItem = 30504028, ImpactId = 31669},
{ItemIndex = 30501229, GiveItem = 30504029, ImpactId = 31670},
{ItemIndex = 30501230, GiveItem = 30504030, ImpactId = 31671},
{ItemIndex = 30501231, GiveItem = 30504031, ImpactId = 31672},
{ItemIndex = 30501232, GiveItem = 30504032, ImpactId = 31673},
{ItemIndex = 30501233, GiveItem = 30504033, ImpactId = 31674},
{ItemIndex = 30501234, GiveItem = 30504034, ImpactId = 31675},
{ItemIndex = 30501235, GiveItem = 30504035, ImpactId = 31676},
{ItemIndex = 30501236, GiveItem = 30504036, ImpactId = 31677},
--绿晶石精华
{ItemIndex = 30501237, GiveItem = 30504028, ImpactId = 31678},
{ItemIndex = 30501238, GiveItem = 30504029, ImpactId = 31679},
{ItemIndex = 30501239, GiveItem = 30504030, ImpactId = 31680},
{ItemIndex = 30501240, GiveItem = 30504031, ImpactId = 31681},
{ItemIndex = 30501241, GiveItem = 30504032, ImpactId = 31682},
{ItemIndex = 30501242, GiveItem = 30504033, ImpactId = 31683},
{ItemIndex = 30501243, GiveItem = 30504034, ImpactId = 31684},
{ItemIndex = 30501244, GiveItem = 30504035, ImpactId = 31685},
{ItemIndex = 30501245, GiveItem = 30504036, ImpactId = 31686},
--血精石精华
{ItemIndex = 30501319, GiveItem = 30504028, ImpactId = 31696},
{ItemIndex = 30501320, GiveItem = 30504029, ImpactId = 31697},
{ItemIndex = 30501321, GiveItem = 30504030, ImpactId = 31698},
{ItemIndex = 30501322, GiveItem = 30504031, ImpactId = 31699},
{ItemIndex = 30501323, GiveItem = 30504032, ImpactId = 31700},
{ItemIndex = 30501324, GiveItem = 30504033, ImpactId = 31701},
{ItemIndex = 30501325, GiveItem = 30504034, ImpactId = 31702},
{ItemIndex = 30501326, GiveItem = 30504035, ImpactId = 31703},      
{ItemIndex = 30501327, GiveItem = 30504036, ImpactId = 31704},
--红宝石精华
{ItemIndex = 30501328, GiveItem = 30504028, ImpactId = 31687},
{ItemIndex = 30501329, GiveItem = 30504029, ImpactId = 31688},
{ItemIndex = 30501330, GiveItem = 30504030, ImpactId = 31689},
{ItemIndex = 30501331, GiveItem = 30504031, ImpactId = 31690},
{ItemIndex = 30501332, GiveItem = 30504032, ImpactId = 31691},
{ItemIndex = 30501333, GiveItem = 30504033, ImpactId = 31692},
{ItemIndex = 30501334, GiveItem = 30504034, ImpactId = 31693},
{ItemIndex = 30501335, GiveItem = 30504035, ImpactId = 31694},
{ItemIndex = 30501336, GiveItem = 30504036, ImpactId = 31695},
}

--**********************************
--事件交互入口
--**********************************
function x332206_OnDefaultEvent( sceneId, selfId, bagIndex )
-- 不需要这个接口，保留空函数
end

--**********************************
--这个物品的使用过程是否类似于技能：
--系统会在执行开始时检测这个函数的返回值，如果返回失败则忽略后面的类似技能的执行。
--返回1：技能类似的物品，可以继续类似技能的执行；返回0：忽略后面的操作。
--**********************************
function x332206_IsSkillLikeScript( sceneId, selfId)
	return 1; --这个脚本需要动作支持
end

--**********************************
--直接取消效果：
--系统会直接调用这个接口，并根据这个函数的返回值确定以后的流程是否执行。
--返回1：已经取消对应效果，不再执行后续操作；返回0：没有检测到相关效果，继续执行。
--**********************************
function x332206_CancelImpacts( sceneId, selfId )
	return 0; --不需要这个接口，但要保留空函数,并且始终返回0。
end

--**********************************
--条件检测入口：
--系统会在技能检测的时间点调用这个接口，并根据这个函数的返回值确定以后的流程是否执行。
--返回1：条件检测通过，可以继续执行；返回0：条件检测失败，中断后续执行。
--**********************************
function x332206_OnConditionCheck( sceneId, selfId )

	--校验使用的物?
	if(1~=LuaFnVerifyUsedItem(sceneId, selfId)) then
		return 0
	end
	
	local FreeSpace = LuaFnGetPropertyBagSpace( sceneId, selfId )
	if( FreeSpace < 1 ) then
	        local strNotice = "道具栏已满，请保留一个空位。"
		      x332206_ShowNotice( sceneId, selfId, strNotice)
	        return 0
	end
	
	local nItemIndex = LuaFnGetItemIndexOfUsedItem( sceneId, selfId )
	local nGiveItemIndex = 0
	local nGiveImpactId = 0
	for i = 1, getn(x332206_g_ItemData) do
		if x332206_g_ItemData[i].ItemIndex == nItemIndex then
			nGiveItemIndex = x332206_g_ItemData[i].GiveItem
			nGiveImpactId = x332206_g_ItemData[i].ImpactId
			break
		end
	end
	
	if nGiveItemIndex == 0 or nGiveImpactId == 0 then
		return 0;
	end
	
	local nHaveImpact = 0
	for i = 1, getn(x332206_g_ItemData) do
		local nRet = LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, x332206_g_ItemData[i].ImpactId)
		if nRet == 1 then
			nHaveImpact = 1
		end
	end
	
	if nHaveImpact == 1 then
		local strNotice = "您身上已经有宝石精华效果了，替换请手动取消该效果。"
		x332206_ShowNotice( sceneId, selfId, strNotice)
		return 0;
	end
	
	return 1; --不需要任何条件，并且始终返回1。
end

--**********************************
--消耗检测及处理入口：
--系统会在技能消耗的时间点调用这个接口，并根据这个函数的返回值确定以后的流程是否执行。
--返回1：消耗处理通过，可以继续执行；返回0：消耗检测失败，中断后续执行。
--注意：这不光负责消耗的检测也负责消耗的执行。
--**********************************
function x332206_OnDeplete( sceneId, selfId )
	
	if(0<LuaFnDepletingUsedItem(sceneId, selfId)) then
		return 1;
	end

	return 0;
end

--**********************************
--只会执行一次入口：
--聚气和瞬发技能会在消耗完成后调用这个接口（聚气结束并且各种条件都满足的时候），而引导
--技能也会在消耗完成后调用这个接口（技能的一开始，消耗成功执行之后）。
--返回1：处理成功；返回0：处理失败。
--注：这里是技能生效一次的入口
--**********************************
function x332206_OnActivateOnce( sceneId, selfId )

	local nItemIndex = LuaFnGetItemIndexOfUsedItem( sceneId, selfId )
	local nGiveItemIndex = 0
	local nGiveImpactId = 0
	for i = 1, getn(x332206_g_ItemData) do
		if x332206_g_ItemData[i].ItemIndex == nItemIndex then
			nGiveItemIndex = x332206_g_ItemData[i].GiveItem
			nGiveImpactId = x332206_g_ItemData[i].ImpactId
			break
		end
	end
	
	if nGiveItemIndex == 0 or nGiveImpactId == 0 then
		return 0;
	end
	
	local nHaveImpact = 0
	for i = 1, getn(x332206_g_ItemData) do
		local nRet = LuaFnHaveImpactOfSpecificDataIndex(sceneId, selfId, x332206_g_ItemData[i].ImpactId)
		if nRet == 1 then
			nHaveImpact = 1
		end
	end
	if nHaveImpact == 1 then
		local strNotice = "您身上已经有宝石精华效果了，替换请手动取消该效果。"
		x332206_ShowNotice( sceneId, selfId, strNotice)
		return 0;
	end
	
	LuaFnSendSpecificImpactToUnit(sceneId, selfId, selfId, selfId, nGiveImpactId, 0)

	BeginAddItem(sceneId)                --给物品
		AddItem(sceneId, nGiveItemIndex, 1)
	local canAdd = LuaFnEndAddItemIgnoreFatigueState( sceneId, selfId )

    if canAdd > 0 then
		LuaFnAddItemListToHumanIgnoreFatigueState(sceneId,selfId)
		local ItemName = GetItemName(sceneId, nGiveItemIndex)
		local strNotice = "您得到了"..ItemName
		x332206_ShowNotice( sceneId, selfId, strNotice)
	end
	
	return 1;
end

--**********************************
--引导心跳处理入口：
--引导技能会在每次心跳结束时调用这个接口。
--返回：1继续下次心跳；0：中断引导。
--注：这里是技能生效一次的入口
--**********************************
function x332206_OnActivateEachTick( sceneId, selfId)
	return 1; --不是引导性脚本, 只保留空函数.
end

function x332206_ShowNotice( sceneId, selfId, strNotice)
	BeginEvent( sceneId )
		AddText( sceneId, strNotice )
	EndEvent( sceneId )
	DispatchMissionTips( sceneId, selfId )    
end

function x332206_ShowRandomSystemNotice( sceneId, selfId, strItemInfo )
	
	--这个函数现在没有用
	--local PlayerName = GetName(sceneId,selfId)
	--local str = format( x332206_g_strGongGaoInfo, PlayerName, strItemInfo )
	--BroadMsgByChatPipe( sceneId, selfId, str, 4 )
	
end
